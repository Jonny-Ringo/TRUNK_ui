<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="index.css">
  <script type="module">
    import { connect, message, result, createDataItemSigner } from "https://unpkg.com/@permaweb/aoconnect";

    const { dryrun } = connect();

    /* For iframe */

    async function getWebsite() {
        try {
        const result = await dryrun({
            process: "JF1O362-tW01hpV7Lm3pLeSEBxcFaStQ-wqT4UzhYpw",
            tags: [
            { name: 'Action', value: "Get-Frame" }
            ]
        });
        if (result) {
            return result.Messages[0]
        }
        else
            return "J_6eJSA-NZ8BnmdZVtb3vTTd1_LDVBi4_c4grV7mWGc"
        } catch (e) {
            console.log(e)
            return "J_6eJSA-NZ8BnmdZVtb3vTTd1_LDVBi4_c4grV7mWGc"
        }
    }

    /* For footer */

    async function getVotes() {
        try {
        const result = await dryrun({
            process: "JF1O362-tW01hpV7Lm3pLeSEBxcFaStQ-wqT4UzhYpw",
            tags: [
            { name: 'Action', value: "Get-Votes" }
            ]
        });
        if (result) {
            return JSON.parse(result.Messages[0].Data); 
        }
        else
            return ""
        } catch (e) {
            console.log(e)
            return ""
        }
    }


    function renderVotes(voteData) {
        const colVotes = document.getElementById('col-votes');

        voteData.forEach((item, index) => {
            const container = document.createElement('div');
            container.classList.add('vote-item');

            const heading = document.createElement('h3');
            heading.textContent = `Candidate #${index}`;
            container.appendChild(heading);

            const link = document.createElement('a');
            link.href = `https://arweave.net/${item.tx}`;
            link.textContent = 'Memeframe URL';
            link.target = "_blank";
            container.appendChild(link);

            const votes = document.createElement('p');
            votes.textContent = `Yay: ${item.yay}, Nay: ${item.nay}`;
            container.appendChild(votes);

            const deadline = new Date(item.deadline * 1000);
            const formattedDate = `${('0' + deadline.getDate()).slice(-2)}-${('0' + (deadline.getMonth() + 1)).slice(-2)}-${deadline.getFullYear()}`;
            const deadlineP = document.createElement('p');
            deadlineP.textContent = `Deadline: ${formattedDate}`;
            container.appendChild(deadlineP);

            colVotes.appendChild(container);
        });
    }

    async function connectWallet() {
      if (typeof window === 'undefined' || !window.arweaveWallet) {
        console.log('Please install the ArConnect browser extension to continue')
        return null
      }

      try {
        await window.arweaveWallet.connect(['ACCESS_ADDRESS', 'SIGN_TRANSACTION', 'SIGNATURE'])
        const address = await window.arweaveWallet.getActiveAddress()
        displayAddress(address)
        getBalance('cred')
        getBalance('meme')
      } catch (error) {
        console.log('Error connecting to ArConnect: ', error)
        return null
      }
    }

    document.getElementById('connectButton').addEventListener('click', connectWallet);

    function displayAddress(address) {
      let addressDisplay = document.getElementById('address');
      addressDisplay.textContent = `Connected Address: ${address}`;
      if (address) {
        connectButton.classList.add('hidden'); 
        mintButton.style.display = 'block';
      } else {
        connectButton.classList.remove('hidden');
        mintButton.style.display = 'none';
  }
    }

    async function getBalance(name) {
      if (name === "cred") {
        var process = "Sa0iBLPNyJQrwpTTG-tWLQU-1QeUAJA73DdxGGiKoJc"
      } else {
        var process = "JF1O362-tW01hpV7Lm3pLeSEBxcFaStQ-wqT4UzhYpw"
      }
      try {
        const messageResponse = await message({
          process,
          tags: [
            { name: 'Action', value: "Balance" }
          ],
          signer: createDataItemSigner(window.arweaveWallet),
        });
        const balanceMessage = messageResponse
        try {
            let { Messages, Error } = await result({
                message: balanceMessage,
                process,
            });
            if (Error) {
                alert("Error fetching balances:" + Error);
                return;
            }
            if (!Messages || Messages.length === 0) {
                alert("No messages were returned from ao. Please try later.");
                return;
            }
            const balanceTag = Messages[0].Tags.find((tag) => tag.name === 'Balance')
            const balance = balanceTag ? parseFloat((balanceTag.value / 1000).toFixed(4)) : 0;
            if (name === "cred") {
              let credBalance = document.getElementById('credBalance');
              credBalance.textContent = `CRED: ${balance}`;
            } else {
              let memeBalance = document.getElementById('memeBalance');
              memeBalance.textContent = `MEME: ${balance}`;
            }
        } catch (error) {
            alert("There was an error when loading balances: " + error)
        }
      } catch (e) {
          console.log(e)
          return "could not fetch"
      }
    }

    async function mint() {
      try {
          const getMintMessage = await message({
              process: "Sa0iBLPNyJQrwpTTG-tWLQU-1QeUAJA73DdxGGiKoJc",
              tags: [
                  { name: 'Action', value: 'Transfer' },
                  { name: 'Quantity', value: '1000' },
                  { name: 'Recipent', value: 'JF1O362-tW01hpV7Lm3pLeSEBxcFaStQ-wqT4UzhYpw' },
              ],
              signer: createDataItemSigner(window.arweaveWallet),
          });
          try {
              let { Messages, Error } = await result({
                  message: getMintMessage,
                  process: "JF1O362-tW01hpV7Lm3pLeSEBxcFaStQ-wqT4UzhYpw",
              });
              if (Error) {
                  alert("Error handling staking:" + Error);
                  return;
              }
              if (!Messages || Messages.length === 0) {
                  alert("No messages were returned from ao. Please try later.");
                  return; 
              }
              alert(Messages[0].Data)
              getBalance('meme')
          } catch (error) {
              alert("There was an error when staking WHAT: " + error)
          }
      } catch (error) {
          alert('There was an error staking: ' + error)
      }
    }

    (async () => {
        let arns = false
        // get process id
        let processId = await fetch(window.location.href).then(res => res.headers.get('x-arns-resolved-id'))
        if (!processId) {
        processId = "JF1O362-tW01hpV7Lm3pLeSEBxcFaStQ-wqT4UzhYpw"
        } else {
        arns = true
        }
        // set the main iframe first
        const processResponse = await getWebsite();

        const url = `https://arweave.net/${processResponse.Data}`

        document.getElementById('iframe').innerHTML = `<iframe style = "border:0;width:100%;height:100%" src = "${url}" />`;

        // now set what appears in the footer
        const voteData = await getVotes()
        renderVotes(voteData)
    })();
  </script>
</head>

<body>

  <div id="iframe"></div>

  <div id="footer">
    <div class="footer-col" id="col-votes">
      <h2 class="footer-heading">What are people voting for?</h2>
    </div>
    <div class="footer-col">
      <h2 class="footer-heading">Cast your vote!</h2>
      <ol>
        <li>
          Earn some CRED by completing the <a href="https://cookbook_ao.g8way.io/tutorials/begin/index.html" target="_blank" rel="no-opener no-referrer">quests on ao</a>.
        </li>
        <li>
          Mint MEME with your CRED.
        </li>
        <li>
          Stake your MEME with the community process.
        </li>
        <li>
          Vote on the URL of your dreams.
        </li>
      </ol>
      <button id="connectButton">Connect Wallet</button>
      <button id="mintButton">Mint 1 MEME</button>
      <p id="address">&nbsp;</p>
      <div class="grid-container">
        <div class="grid-item border-right">
          <p class="text-large" id="credBalance">
            &nbsp;
          </p>
        </div>
        <div class="grid-item">
          <p class="text-large" id="memeBalance">
            &nbsp;
          </p>
        </div>
      </div>      
    </div>
  </div>
</body>

</html>